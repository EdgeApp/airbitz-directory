{% load compressed %}
<!doctype html>
<html>
    <head>
        <meta name="google-site-verification" content="KKMUdX_TFC0dy0XA-Tb_HPjaiGLu8OJbOqdDXcCgV48" />
        {% block head %}
            <meta name="csrf-token" content="{{csrf_token}}">
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

            <title>{% block title %}{% endblock %}</title>
            <meta name="viewport" content="width=device-width">
            {% compressed_css 'global' %}
        {% endblock head %}
    </head>
    <body>
        {% block topbar %}
        <div class="navbar navbar-default navbar-static-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="{% url 'landing' %}">Airbitz</a>
                </div>
                <div class="navbar-collapse collapse">
                    <form name="search" class="navbar-form navbar-left" role="search" method="get" action="{% url 'search' %}">
                        <div class="form-group">
                            <input id="q" name="q" type="text" style="width: 200px" placeholder="Business name..." autocomplete="off"  class="typeahead form-control">
                        </div>
                        <div class="form-group">
                            <input id="near" name="near" type="text" style="width: 200px" placeholder="City..." autocomplete="off" class="typeahead form-control">
                        </div>
                        <button type="submit" class="btn"><span class="glyphicon glyphicon-search"></span></button>
                    </form>
                </div><!--/.navbar-collapse -->
            </div>
        </div>
        {% endblock %}

        <div id="wrap">
            <div class="container">
                {% block message %}
                    {% if messages %}
                        <div class="row">
                            {% for message in messages %}
                                <li{% if message.tags %} class="alert {{ message.tags }}"{% endif %}>{{ message }}</li>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endblock message %}

                {% block body %}
                {% endblock %}
            </div><!-- /.container -->
        </div><!-- /#wrap -->

        {% block footer %}
            <div class="footer">
                <p class="text-center">
                    &copy; {% now "Y" %} - AirBitz&nbsp;
                </p>
            </div>
        {% endblock %}

        {% block javascript_headers %}
            {% compressed_js 'core' %}
        {% endblock javascript_headers %}
        {% block javascript %}
            <script type="text/javascript">
                var addMap = function(selector, zoom, lat, lon, markers) {
                    function initialize() {
                        var mapOptions = {
                            center: new google.maps.LatLng(lat, lon),
                            zoom: zoom,
                            disableDefaultUI: true,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        var map = new google.maps.Map(selector[0], mapOptions);
                        for (var i = 0; i < markers.length; ++i) {
                            var m = markers[i];
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(m.lat, m.lon),
                                map: map
                            });
                        }
                    }
                    google.maps.event.addDomListener(window, 'load', initialize);
                    return map;
                };
                var addPlaceSearch = function(selector, near) {
                    var end = '';
                    if (near) {
                        end += '&near=1';
                    }
                    var geo = Geo.latestLocation();
                    if (geo) {
                        end += '&lat=' + geo.coords.latitude + '&lon=' + geo.coords.longitude;
                    }
                    selector.typeahead('destroy');
                    selector.typeahead([{
                        name: 'business',
                        remote: {
                            url: '/api/v1/autocomplete-business/?q=%QUERY' + end,
                            filter: function(data) {
                                return data.map(function(e, i) {
                                    return { name: e.name, value: e.name, id: e.pk };
                                });
                            }
                        },
                        template: function(datum) {
                            return '<p>' + datum.name + '</p>';
                        },
                    }]);
                    selector.on('typeahead:selected', function (object, datum) {
                        location.href = '/biz/' + datum.id;
                    });
                };
                var Geo = {
                    latestLocation: function() {
                        var cookie = Util.getCookie('geo');
                        try {
                            var geo = JSON.parse(cookie);
                        } catch (e) {
                            console.log(e);
                        }
                        return geo;
                    },
                    requestLocation: function() {
                        var now = new Date();
                        var geo = this.latestLocation();
                        if (geo) {
                            try {
                                var then = new Date(geo.timestamp).getTime();
                                if (now - then < 1000 * 60 * 60 * 1) {
                                    return;
                                }
                            } catch (e) {
                                console.log(e);
                            }
                        }
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(this.postPosition);
                        }
                    },
                    postPosition: function(geo) {
                        Util.setCookie('geo', JSON.stringify(geo), 1);
                    }
                };
                var Util = {
                    csrfSafeMethod: function() {
                        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                    },
                    setCookie: function(c_name, value, exdays) {
                        var exdate = new Date();
                        exdate.setDate(exdate.getDate() + exdays);
                        var c_value = escape(value) + ((exdays===null) ? "" : "; expires="+exdate.toUTCString());
                        document.cookie=c_name + "=" + c_value;
                    },
                    getCookie: function(c_name) {
                        var c_value = document.cookie;
                        var c_start = c_value.indexOf(" " + c_name + "=");
                        if (c_start == -1) {
                            c_start = c_value.indexOf(c_name + "=");
                        }
                        if (c_start == -1) {
                            c_value = null;
                        } else {
                            c_start = c_value.indexOf("=", c_start) + 1;
                            var c_end = c_value.indexOf(";", c_start);
                            if (c_end == -1) {
                            c_end = c_value.length;
                            }
                            c_value = unescape(c_value.substring(c_start,c_end));
                        }
                        return c_value;
                    }
                };
                $(function() {
                    $("form[name='search']").submit(function() {
                        var geo = Geo.latestLocation();
                        if (geo) {
                            var lat = $("<input>")
                                        .attr("type", "hidden")
                                        .attr("name", "lat").val(geo.coords.latitude);
                            var lon = $("<input>")
                                        .attr("type", "hidden")
                                        .attr("name", "lon").val(geo.coords.longitude);
                            $(this).append($(lat));
                            $(this).append($(lon));
                        }
                        return true;
                    });
                    addPlaceSearch($('#q'));
                    addPlaceSearch($('#near'), true);
                    Geo.requestLocation();
                });
            </script>
        {% endblock javascript %}
    </body>
</html>

