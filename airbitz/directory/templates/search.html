{% extends 'base.html' %}
{% load imagekit %}
{% load compressed %}
{% load bootstrap_pagination %}

{% block title %}Search{% endblock title %}


{% block javascript_headers %}
    {{ block.super }}
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={% if not DEBUG %}{{ mapkey }}{% endif %}&sensor=false"> </script>
    {% compressed_js 'search' %}
    {% compressed_css 'search' %}
    <script type="text/javascript">
        // FOR REGION MAP
        var activeRegions = {{ active_regions|safe }}
        var allRegions = {{ all_regions|safe }}
	  </script>

    {# clickable panel headings #}
    <script>
      $(document).on('click', '.panel-heading span.clickable', function (e) {
          var $this = $(this);
          if (!$this.hasClass('panel-collapsed')) {
              $this.parents('.panel').find('.panel-body').slideUp();
              $this.addClass('panel-collapsed');
              $this.find('i').removeClass('glyphicon-minus').addClass('glyphicon-plus');
          } else {
              $this.parents('.panel').find('.panel-body').slideDown();
              $this.removeClass('panel-collapsed');
              $this.find('i').removeClass('glyphicon-plus').addClass('glyphicon-minus');
          }
      });
      $(document).on('click', '.panel div.clickable', function (e) {
          var $this = $(this);
          if (!$this.hasClass('panel-collapsed')) {
              $this.parents('.panel').find('.panel-body').slideUp();
              $this.addClass('panel-collapsed');
              $this.find('i').removeClass('glyphicon-minus').addClass('glyphicon-plus');
          } else {
              $this.parents('.panel').find('.panel-body').slideDown();
              $this.removeClass('panel-collapsed');
              $this.find('i').removeClass('glyphicon-plus').addClass('glyphicon-minus');
          }
      });
      $(document).ready(function () {
          $('.panel-heading span.clickable').click();
          $('.panel div.clickable').click();
      });
    </script>
{% endblock javascript_headers %}

{% block body %}

{% if not results %} {# NO RESULTS #}

    {% include '_results_not_found.html' %}

{% else %}  {# SHOW RESULTS #}

    {% if request.GET.location == 'On the Web' %}
    <div class="results-area">
        <div class="row">
            <div class="col-sm-12">
                <h1 class="search-title hidden-xs hidden-sm">Bitcoin Businesses On the Web</h1>
                <h1 class="search-title visible-xs visible-sm">Search Results</h1>
                {% if results_info.total > results_info.results_per_page %}
                    <div class="pagination-area">
                        {% bootstrap_paginate page_obj range=10 %}
                    </div>
                {% endif %}
                    <div class="pagination-info row">
                        <strong>{{ results_info.total }}</strong> Total Results Found
                    </div>
            </div>
        </div>

        <div class="results-grid list-group row">
            {% block result_grid_items %}
                {% for rbiz in results %}
                    {% include '_result_grid_item.html' %}
                {% endfor %}
            {% endblock result_grid_items %}
        </div>
    </div><!-- /.results-area -->

      {% if results_info.total > results_info.results_per_page %}
          <div class="pagination-area">
              {% bootstrap_paginate page_obj range=10 %}
          </div>
      {% endif %}
          <div class="pagination-info row">
              <strong>{{ results_info.total }}</strong> Total Results Found
          </div>

    {% else %}


    <div class="results-map-list row">
        <div class="col-sm-6">
            <div class="row">
              <h1 class="search-title hidden-xs hidden-sm">Bitcoin Business Results</h1>
              <h1 class="search-title visible-xs visible-sm">Search Results</h1>
            </div>

            <div class="row">
              <h4>You Searched <span class="term label label-primary">{{ term }}</span> near <span class="location label label-default">{{ location }}</span></h4>
              <h5>Found: {{ results_info.total }}</h5>
            </div>

            <div class="search-info row">

              <div class="search-filters panel panel-default">
                  <div class="panel-heading clickable">
                      <h3 class="panel-title">Search Filters</h3>
                      <span class="pull-right "><i class="fa fa-chevron-circle-down"></i></span>
                  </div>
                  <div class="panel-body">
                      <form class="form-horizontal" role="form">
                        <legend>Business Types</legend>
                        <div class="radio pull-left">
                          <label>
                            <input type="radio" name="s_type" value="" checked> <i class="fa fa-asterisk"></i> All
                          </label>
                        </div>
                        <div class="radio pull-left">
                          <label>
                            <input type="radio" name="s_type" value="local"> <i class="fa fa-map-marker"></i> Local
                          </label>
                        </div>
                        <div class="radio pull-left">
                          <label>
                            <input type="radio" name="s_type" value="web"> <i class="fa fa-globe"></i> Web
                          </label>
                        </div>
                      </form>
                  </div>
              </div>

            </div>

            {% if results_info.total > results_info.results_per_page %}
                <div class="pagination-area row">
                    {% bootstrap_paginate page_obj range=8 %}
                </div>
            {% endif %}
{#                <div class="pagination-info row">#}
{#                    <strong>{{ results_info.total }}</strong> Total Results Found, <strong>{{ results_info.results_left }}</strong> Shown on Map#}
{#                </div>#}

            {% block results_list_items %}
                {% for biz in results %}
                    {% include '_result_list_item.html' %}
                {% endfor %}
            {% endblock results_list_items %}

            {% if results_info.total > results_info.results_per_page %}
                <div class="pagination-area row">
                    {% bootstrap_paginate page_obj range=10 %}
                </div>
            {% endif %}
                <div class="pagination-info row">
                    <strong>{{ results_info.total }}</strong> Total Results Found, <strong>{{ results_info.results_left }}</strong> Shown on Map
                </div>

        </div>
        <div class="location-search-info hidden-xs col-sm-6">
            <div class="map-container" data-spy="affix" data-offset-top="0">
                <div id="map"></div>
            </div>
        </div>
    </div>

    {% endif %}

{% endif %} {# END OF RESULTS #}

{% endblock %}


{% block javascript %}
    {{ block.super }}
    <script type="text/javascript">

        var markersJSON = [
        {% for biz in results %}
            {   lat: {{ biz.center.y }},
                lon: {{ biz.center.x }},
                name: "{{ biz.name }}",
                cats: '{% for c in biz.categories.all %}<span class="map-marker-cat label label-primary">{{c.name}}</span>{% empty %}<span class="label label-warning">Uncategorized</span>{% endfor %}',
                address: '{{ biz.address }}',
                img: '{% if biz.landing_image %}{% thumbnail "65x65" biz.landing_image.image -- class="marker-img" %}{% endif %}',
                url: '{% url 'business_info' biz.id %}',
                directions_url: '{{ biz.gmap_directions_url }}'
            },
        {% endfor %}
        {} ];

        var json = markersJSON;

        $(function() {
        {% if searchLocation %}
            var polygon = [
            {% for l in searchLocation.bounding %}
                {% for p in l.geom %}
                    { lat: {{ p.1 }}, lon: {{ p.0 }} },
                {% endfor %}
            {% endfor %}
            {} ];
            AB.addMap($('#map'), 5, {{ searchLocation.sortPoint.y }}, {{ searchLocation.sortPoint.x }}, json, polygon);
        {% elif userLocation %}
            AB.addMap($('#map'), 5, {{ userLocation.y }}, {{ userLocation.x }}, json);
        {% else %}
        if (json.length > 0) {
            AB.addMap($('#map'), 5, json[0].lat, json[0].lon, json);
        }
        {% endif %}
        });

    </script>
{% endblock %}
