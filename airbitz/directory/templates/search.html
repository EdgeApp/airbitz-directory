{% extends 'base.html' %}
{% load imagekit %}
{% load compressed %}
{% load ab_custom_tags %}
{% load bootstrap_pagination %}

{% block title %}Search{% endblock title %}

{% block body %}

    {% if request.GET.location == 'On the Web' %}
    <div class="row">
        <div class="col-sm-12">
            <h1 class="search-title hidden-xs hidden-sm">Bitcoin Businesses On the Web</h1>
            <h1 class="search-title visible-xs visible-sm">Search Results</h1>
            <hr />
        </div>
    </div>
    <div class="results-grid list-group row">

        {% block result_grid_items %}
            {% for rbiz in results %}
                {% include '_result_grid_item.html' %}
            {% empty %}
                <p>No results found.</p>
            {% endfor %}
        {% endblock result_grid_items %}
    </div><!-- /.results-grid -->

    {% else %}

    <div class="results-map-list row">
        <div class="col-sm-6">
            <h1 class="search-title hidden-xs hidden-sm row">Bitcoin Business Search Results</h1>
            <h1 class="search-title visible-xs visible-sm row">Search Results</h1>

            {% for biz in results %}
                <div class="result-list-item row" >
                    {% if biz.has_bitcoin_discount > 0 %}
                        <span class="biz-discount label label-success" title="Discount for Bitcoin"><i class="fa fa-bitcoin"></i> {{ biz.has_bitcoin_discount|decimal_to_percent }} Discount</span>
                    {% endif %}
                    <a href="{% url 'business_info' biz.id %}" title="{{ biz.name }}">
                    {% if biz.landing_image %}
                        {% thumbnail '150x150' biz.landing_image.image -- class="biz-img" %}
                    {% else %}
                        <img data-src="holder.js/150x150/ab-blue/text:{{ biz.name }}" class="biz-img">
                    {% endif %}
                    </a>

                    <h2 class="biz-name single-line" title="{{ biz.name }}">
                        <a href="{% url 'business_info' biz.id %}" title="{{ biz.name }}">{{ biz.name }}</a>
                    </h2>

                    <div class="biz-meta">
                        <div class="biz-categories">
                            {% for c in biz.categories.all %}
                                <span class="label label-primary">{{c.name}}</span>
                            {% empty %}
                                <span class="label label-warning">Uncategorized</span>
                            {% endfor %}
                        </div>

                        {% if biz.address %}
                            <div class="biz-location">
                                <span class="biz-address-street"><i class="fa fa-map-marker"></i> {{ biz.address }}</span>
                                {% if biz.distance %}
                                    <span class="biz-distance"><i class="fa fa-crosshairs"></i> {{ biz.distance.mi|floatformat:2 }}mi</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <br />
                        {% endif %}
                    </div>

                    <div class="biz-description">
                        {% if biz.description %}
                            {{ biz.description }}
                        {% else %}
                            Description... Lorem ipsum dolor sit amet, consectetuer adipiscing elit,
                            sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p>No results found.</p>
            {% endfor %}
        </div>
        <div class="map-container hidden-xs col-sm-6">
            <div data-spy="affix" data-offset-top="0">
                <div id="map"></div>
            </div>
            <div class="pagination-container text-center" data-spy="affix" data-offset-top="0">
                {% bootstrap_paginate page_obj range=10 %}
            </div>
        </div>
    </div>

    {% endif %}


{% endblock %}

{% block javascript_headers %}
    {{ block.super }}
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={{ mapkey }}&sensor=false"> </script>
    {% compressed_js 'directory' %}
{% endblock javascript_headers %}

{% block javascript %}
    {{ block.super }}
    <script type="text/javascript">

        var markersJSON = [
        {% for biz in results %}
            {   lat: {{ biz.center.y }},
                lon: {{ biz.center.x }},
                name: "{{ biz.name }}",
                cats: '{% for c in biz.categories.all %}<span class="map-marker-cat label label-primary">{{c.name}}</span>{% empty %}<span class="label label-warning">Uncategorized</span>{% endfor %}',
                address: '{{ biz.address }}',
                url: '{% url 'business_info' biz.id %}'
            },
        {% endfor %}
        {} ];

        var json = markersJSON;

        $(function() {
        {% if searchLocation %}
            var polygon = [
            {% for l in searchLocation.bounding %}
                {% for p in l %}
                    { lat: {{ p.1 }}, lon: {{ p.0 }} },
                {% endfor %}
            {% endfor %}
            {} ];
            AB.addMap($('#map'), 5, {{ searchLocation.point.y }}, {{ searchLocation.point.x }}, json, polygon);
        {% elif userLocation %}
            AB.addMap($('#map'), 5, {{ userLocation.y }}, {{ userLocation.x }}, json);
        {% else %}
        if (json.length > 0) {
            AB.addMap($('#map'), 5, json[0].lat, json[0].lon, json);
        }
        {% endif %}
        });




{#        console.log(markersJSON);#}

        for (var i = 0; i < markersJSON.length; ++i) {
            var m = markersJSON[i];
            if (m.lat && m.lon) {
{#                console.log(m.lat + ', ' + m.lon)#}
            }
        }

        $("#map2").height("500px").gmap3({
            map: {
                options: {
                    center: [{{ userLocation.y }},{{ userLocation.x }}],
                    zoom: 10,
                    disableDefaultUI: true,
                }
            },



            marker: {
                latLng:[json[0].lat,json[0].lon]
            }

        });
    </script>
{% endblock %}
