{% extends 'base.html' %}
{% load imagekit %}
{% load compressed %}
{% load bootstrap_pagination %}

{% block title %}Search{% endblock title %}

{% block body %}

{% if not results %} {# NO RESULTS #}

    {% include '_results_not_found.html' %}

{% else %}  {# SHOW RESULTS #}

    {% if request.GET.location == 'On the Web' %}
    <div class="results-area">
        <div class="row">
            <div class="col-sm-12">
                <h1 class="search-title hidden-xs hidden-sm">Bitcoin Businesses On the Web</h1>
                <h1 class="search-title visible-xs visible-sm">Search Results</h1>
                {% bootstrap_paginate page_obj range=15 %}
                <div class="row" style="margin-bottom: 20px;">
                    <div class="col-sm-12"><strong>{{ results_info.total }}</strong> Total Results Found, <strong>{{ results_info.results_per_page }}</strong> Shown on Page</div>
                </div>
            </div>
        </div>

        <div class="results-grid list-group row">
            {% block result_grid_items %}
                {% for rbiz in results %}
                    {% include '_result_grid_item.html' %}
                {% endfor %}
            {% endblock result_grid_items %}
        </div>
    </div><!-- /.results-area -->

    <div class="row">
        <div class="col-sm-12">
            {% bootstrap_paginate page_obj range=15 %}
            <div class="row" style="margin-bottom: 20px;">
                <div class="col-sm-12"><strong>{{ results_info.total }}</strong> Total Results Found, <strong>{{ results_info.results_per_page }}</strong> Shown on Page</div>
            </div>
        </div>
    </div>

    {% else %}

    <div class="results-map-list row">
        <div class="col-sm-6">
            <h1 class="search-title hidden-xs hidden-sm row">Bitcoin Business Search Results</h1>
            <h1 class="search-title visible-xs visible-sm row">Search Results</h1>

            {% block results_list_items %}
                {% for biz in results %}
                    {% include '_result_list_item.html' %}
                {% endfor %}
            {% endblock results_list_items %}

            <div class="row">
                <div class="col-sm-12">
                {% bootstrap_paginate page_obj range=10 %}
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12"><strong>{{ results_info.total }}</strong> Total Results Found, <strong>{{ results_info.results_per_page }}</strong> Shown on Map</div>
            </div>

        </div>
        <div class="location-search-info hidden-xs col-sm-6">
            <div class="map-container" data-spy="affix" data-offset-top="0">
                <div id="map"></div>
            </div>
            <div class="pagination-container" data-spy="affix" data-offset-top="0">
                <div class="row">
                    <div class="col-sm-12">
                    {% bootstrap_paginate page_obj range=10 %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12"><strong>{{ results_info.total }}</strong> Total Results Found, <strong>{{ results_info.results_per_page }}</strong> Shown on Map</div>
                </div>

            </div>
        </div>
    </div>

    {% endif %}

{% endif %} {# END OF RESULTS #}

{% endblock %}

{% block javascript_headers %}
    {{ block.super }}
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={% if not DEBUG %}{{ mapkey }}{% endif %}&sensor=false"> </script>
    {% compressed_js 'directory' %}
{% endblock javascript_headers %}

{% block javascript %}
    {{ block.super }}
    <script type="text/javascript">

        var markersJSON = [
        {% for biz in results %}
            {   lat: {{ biz.center.y }},
                lon: {{ biz.center.x }},
                name: "{{ biz.name }}",
                cats: '{% for c in biz.categories.all %}<span class="map-marker-cat label label-primary">{{c.name}}</span>{% empty %}<span class="label label-warning">Uncategorized</span>{% endfor %}',
                address: '{{ biz.address }}',
                img: '{% if biz.landing_image %}{% thumbnail "65x65" biz.landing_image.image -- class="marker-img" %}{% endif %}',
                url: '{% url 'business_info' biz.id %}',
                directions_url: '{{ biz.gmap_directions_url }}'
            },
        {% endfor %}
        {} ];

        var json = markersJSON;

        $(function() {
        {% if searchLocation %}
            var polygon = [
            {% for l in searchLocation.bounding %}
                {% for p in l.geom %}
                    { lat: {{ p.1 }}, lon: {{ p.0 }} },
                {% endfor %}
            {% endfor %}
            {} ];
            AB.addMap($('#map'), 5, {{ searchLocation.sortPoint.y }}, {{ searchLocation.sortPoint.x }}, json, polygon);
        {% elif userLocation %}
            AB.addMap($('#map'), 5, {{ userLocation.y }}, {{ userLocation.x }}, json);
        {% else %}
        if (json.length > 0) {
            AB.addMap($('#map'), 5, json[0].lat, json[0].lon, json);
        }
        {% endif %}
        });




        var activeRegions = {{ active_regions|safe }}

        function checkActive(region) {
{#            return (activeRegions.indexOf(region) == -1);#}
            return typeof activeRegions[region] == 'undefined';
        }

        var vmapOptions = {
            map: '',
            backgroundColor: '#ddd',
            stroke: '#999999',
            color: '#ffffff',
            hoverColor: '#22bbcf',
            selectedColor: '#2299cf',
            colors: {
                {% for region in active_regions %}
                    '{{ region }}': '#2299cf',
                {% endfor %}
            }
        }

        // set up map options
        var vmapUS = $.extend(true, {}, vmapOptions);
        vmapUS.map = 'us_aea_en'
        var vmapCA = $.extend(true, {}, vmapOptions);
        vmapCA.map = 'ca_lcc_en';
        var vmapEU = $.extend(true, {}, vmapOptions);
        vmapEU.map = 'europe_mill_en';

        // initialize maps
        $('#vmap-us').vectorMap(vmapUS);
        $('#vmap-ca').vectorMap(vmapCA);
        $('#vmap-eu').vectorMap(vmapEU);


        $('#vmap-us, #vmap-ca').bind('regionClick.jvectormap', function(event, label, region){
            if( checkActive(label) ){   // regionClick is not active or upcoming
                console.log('OK REQUEST ' + label);
                $('#area-info').addClass('hidden');
                $('#area-form').removeClass('hidden');
                $('#area-request').html(label).hide().fadeIn('slow');
                $('#area-request-input').val(label);
                $.ajaxSetup({ crossDomain: true });
            } else {
                var urlLocation = activeRegions[label]['search'];
{#                var urlTerm = '{{ request.GET.term }}';#}
{#                var searchUrl = 'search?term=' + encodeURI(urlTerm) + '&location=' + urlLocation;#}
                var searchUrl = 'search?location=' + urlLocation;
                window.location = searchUrl;
            }
        });

        $('#vmap-us, #vmap-ca').bind('labelShow.jvectormap', function(event, label, code){
            if( checkActive(code) ){    // regionHover is not active or upcoming
                label.html('<span class="hover-click-text">Click to Request</span> ' + $(label[0]).html());
            } else {
                var regionName = $(label[0]).html();
                label.html('<span class="hover-region-name">' + regionName + '</span> <span class="hover-click-text">Click to Query</span>')
            }
        });

        $('.panel-title > a').on('click', function(){
            $('.panel-collapse').fadeIn().resize(); // gotta resize the hidden containers or the map won't show properly
        });

        $('#cancelEmail').on('click', function(e){
            e.preventDefault();
            $('#area-info').toggleClass('hidden');
            $('#area-form').toggleClass('hidden');
        });

    </script>
{% endblock %}
